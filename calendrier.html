<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendrier et Agenda Quotidien</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lobster&display=swap');

        body {
            font-family: Arial, sans-serif;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
        }

        table {
            border-collapse: separate;
            width: 50%; /* Réduire la taille du calendrier */
            margin: 0 auto; /* Centrer le calendrier */
            border-radius: 12px;
            overflow: hidden;
        }
        th, td {
            border: 1px solid blue;
            text-align: center;
            padding: 8px;
        }
        th {
            background-color: #f2f2f2;
        }
        .today {
            background-color: #d3d3d3; /* Couleur gris clair pour la date du jour */
        }
        .clickable {
            cursor: pointer;
        }
        .selected {
            background-color: #add8e6;
        }
        .button {
            font-family: 'Lobster', cursive;
            border: 4px solid blue;
            background-color: #5DADE2;
            color: white;
            padding: 6px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 11px;
            margin: 4px 1px;
            cursor: pointer;
            border-radius: 12px;
        }
        .button:hover {
            background-color: #5DADE2;
        }
        #monthYear {
            font-weight: bold;
        }
        th:first-child {
            border-top-left-radius: 12px;
        }
        th:last-child {
            border-top-right-radius: 12px;
        }
        td:first-child:last-child {
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }
        div {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>Calendrier et Agenda Quotidien</h1>
    <p id="commitMessage" style="font-size: 10px;"></p>
    <div>
        <button class="button" onclick="changeMonth(-1)">Precedente</button>
        <span id="monthYear"></span>
        <button class="button" onclick="changeMonth(1)">Siguiente</button>
    </div>
    <table id="calendarTable">
        <tr>
            <th>Lu</th>
            <th>Ma</th>
            <th>Mie</th>
            <th>Ju</th>
            <th>Vie</th>
            <th>Sa</th>
            <th>Do</th>
        </tr>
    </table>
    <p id="selectedDateDisplay"></p>
    <button class="button" onclick="saveDate()">Mostrar la fecha</button>
    <button class="button" onclick="createEvent()">Crear evento</button>
    <div id="eventList"></div>

    <!-- input type="date" id="calendar"-->
    <!-- div id="agenda"></div-->
  
    <!-- Formulaire pour ajouter un événement -->
    <div class="new-event">
        <h2>Nuevo evento</h2>
        <form id="newEventForm">
            <input type="text" id="Telefono" required>
            <input type="text" id="Nombre" required>
            <input type="date" id="Fecha" required>
            <input type="number" id="Hora" required>
            <input type="number" id="Min" required>
            <input type="text" id="Lugar" required>
            <input type="text" id="Precio" required>
            <input type="text" id="Trabajo" required>
            <button type="button" id="addEventButton">Ajouter</button>
        </form>
    </div>
    <script type="module">
        import { supabase } from './supabaseClientAgendaJour.js';

        document.addEventListener('DOMContentLoaded', function() {
            loadJournalierContent();
            loadTableData();

            document.getElementById('addEventButton').addEventListener('click', async function() {
                const newEvent = {
                    id: generateUniqueId(), // Générer un ID unique
                    Telefono: document.getElementById('Telefono').value,
                    Nombre: document.getElementById('Nombre').value,
                    Fecha: document.getElementById('Fecha').value,
                    Hora: document.getElementById('Hora').value,
                    Min: document.getElementById('Min').value,
                    Lugar: document.getElementById('Lugar').value,
                    Precio: document.getElementById('Precio').value,
                    Trabajo: document.getElementById('Trabajo').value
                };

                console.log('Nouvel événement à ajouter :', newEvent);

                const { data, error } = await supabase
                    .from('event_quot1')
                    .insert([newEvent]);

                if (error) {
                    console.error('Erreur lors de l\'insertion des données :', error);
                } else {
                    console.log('Données insérées avec succès :', data);
                    loadTableData(); // Recharger les données pour afficher le nouvel événement
                }
            });

            document.getElementById('Telefono').addEventListener('input', async function() {
                const telefono = this.value;

                if (telefono) {
                    const { data, error } = await supabase
                        .from('tableData1')
                        .select('Nombre, Lugar')
                        .eq('Telefono', telefono);

                    if (error) {
                        console.error('Erreur lors de la récupération des données :', error);
                    } else if (data.length > 0) {
                        const { Nombre, Lugar } = data[0];
                        document.getElementById('Nombre').value = Nombre;
                        document.getElementById('Lugar').value = Lugar;
                    } else {
                        // Si aucun résultat n'est trouvé, vider les champs
                        document.getElementById('Nombre').value = '';
                        document.getElementById('Lugar').value = '';
                    }
                } else {
                    // Si le champ de téléphone est vide, vider les champs
                    document.getElementById('Nombre').value = '';
                    document.getElementById('Lugar').value = '';
                }
            });
        });

        async function loadJournalierContent() {
            try {
                const response = await fetch('journalier.html');
                const text = await response.text();
                document.getElementById('journalierContent').innerHTML = text;
            } catch (error) {
                console.error('Erreur lors du chargement du contenu de journalier.html :', error);
            }
        }

        async function loadTableData() {
            try {
                const { data, error } = await supabase
                    .from('event_quot1')
                    .select('*');

                if (error) {
                    console.error('Error fetching data:', error);
                    return;
                }

                console.log('Data fetched from Supabase:', data);

                const tbody = document.querySelector('#journalierTable tbody');
                if (tbody) {
                    tbody.innerHTML = ''; // Effacer les anciennes lignes
                    data.forEach(rowData => {
                        const row = tbody.insertRow();
                        Object.entries(rowData).forEach(([key, value]) => {
                            const cell = row.insertCell();
                            cell.textContent = value;
                            cell.contentEditable = "true";
                            cell.dataset.column = key; // Ajouter un attribut pour identifier la colonne
                            if (key === 'Telefono') {
                                cell.dataset.telefono = value; // Ajouter un attribut pour identifier la ligne
                            }
                        });
                    });
                } else {
                    console.error('Element with ID "journalierTable" not found.');
                }
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // Fonction pour générer un ID unique
        function generateUniqueId() {
            return 'id-' + Math.random().toString(36).substr(2, 9);
        }

    </script>

    <!-- Tableau modifiable -->
    <table id="editable-table">
        <thead>
            <tr>
                <th>Telefono</th>
                <th>Nombre</th>
                <th>Fecha</th>
                <th>Hora</th>
                <th>Min</th>
                <th>Lugar</th>
                <th>Precio</th>
                <th>Trabajo</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td contenteditable="true"></td>
                <td contenteditable="true"></td>
                <td contenteditable="true"></td>
                <td contenteditable="true"></td>
                <td contenteditable="true"></td>
                <td contenteditable="true"></td>
                <td contenteditable="true"></td>
                <td contenteditable="true"></td>
            </tr>
            <tr>
                <td contenteditable="true"></td>
                <td contenteditable="true"></td>
                <td contenteditable="true"></td>
                <td contenteditable="true"></td>
                <td contenteditable="true"></td>
                <td contenteditable="true"></td>
                <td contenteditable="true"></td>
                <td contenteditable="true"></td>
            </tr>
            <!-- Ajoutez plus de lignes si nécessaire -->
        </tbody>
    </table>

    <script>
        var currentMonth = new Date().getMonth();
        var currentYear = new Date().getFullYear();
        var event = {}; // Objet pour stocker les événements par date

        const monthNames = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];
        
        function generateCalendar(month, year) {
            const calendarTable = document.getElementById('calendarTable');
            const monthYearDisplay = document.getElementById('monthYear');
            calendarTable.innerHTML = `
                <tr>
                    <th>Lu</th>
                    <th>Ma</th>
                    <th>Mie</th>
                    <th>Ju</th>
                    <th>Vie</th>
                    <th>Sa</th>
                    <th>Do</th>
                </tr>
            `;

            const firstDay = (new Date(year, month).getDay() + 6) % 7; // Ajustement pour commencer par lundi
            const daysInMonth = 32 - new Date(year, month, 32).getDate();
            let date = 1;

            for (let i = 0; i < 6; i++) {
                let row = document.createElement('tr');

                for (let j = 0; j < 7; j++) {
                    if (i === 0 && j < firstDay) {
                        let cell = document.createElement('td');
                        let cellText = document.createTextNode('');
                        cell.appendChild(cellText);
                        row.appendChild(cell);
                    } else if (date > daysInMonth) {
                        break;
                    } else {
                        let cell = document.createElement('td');
                        let cellText = document.createTextNode(date);
                        cell.classList.add('clickable');
                        cell.addEventListener('click', handleDateClick);
                        if (date === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear()) {
                            cell.classList.add('today');
                        }
                        cell.appendChild(cellText);
                        row.appendChild(cell);
                        date++;
                    }
                }

                calendarTable.appendChild(row);
            }

            monthYearDisplay.textContent = monthNames[month] + ' ' + year;
        }

        function handleDateClick(event) {
            const clickedDate = event.target.textContent;
            const selectedDateDisplay = document.getElementById('selectedDateDisplay');
            selectedDateDisplay.textContent = 'Date sélectionnée : ' + clickedDate + ' ' + monthNames[currentMonth] + ' ' + currentYear;

            document.querySelectorAll('.clickable').forEach(dateElement => {
                dateElement.classList.remove('selected');
            });

            event.target.classList.add('selected');

            // Mettre à jour le champ de date du formulaire
            const selectedDate = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(clickedDate).padStart(2, '0')}`;
            document.getElementById('Fecha').value = selectedDate;
        }

        function selectToday() {
            const today = new Date();
            const todayDate = today.getDate();
            const todayMonth = today.getMonth();
            const todayYear = today.getFullYear();

            if (todayMonth === currentMonth && todayYear === currentYear) {
                document.querySelectorAll('.clickable').forEach(dateElement => {
                    if (parseInt(dateElement.textContent) === todayDate) {
                        dateElement.classList.add('selected');
                        const selectedDateDisplay = document.getElementById('selectedDateDisplay');
                        selectedDateDisplay.textContent = 'Date sélectionnée : ' + todayDate + ' ' + monthNames[todayMonth] + ' ' + todayYear;
                        // Mettre à jour le champ de date du formulaire
                        const selectedDate = `${todayYear}-${String(todayMonth + 1).padStart(2, '0')}-${String(todayDate).padStart(2, '0')}`;
                        document.getElementById('Fecha').value = selectedDate;
                    }
                });
            }
        }

        window.onload = function() {
            generateCalendar(currentMonth, currentYear);
            selectToday();
        };

        function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            generateCalendar(currentMonth, currentYear);
        }

        function saveDate() {
            const selectedDateDisplay = document.getElementById('selectedDateDisplay');
            const selectedDate = selectedDateDisplay.textContent.split(' : ')[1];
            const tableBody = document.querySelector('#editable-table tbody');
            const rows = tableBody.querySelectorAll('tr');

            event[selectedDate] = [];
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = {
                    telefono: cells[0].textContent,
                    nombre: cells[1].textContent,
                    fecha: cells[2].textContent,
                    hora: cells[3].textContent,
                    min: cells[4].textContent,
                    lugar: cells[5].textContent,
                    precio: cells[6].textContent,
                    travail: cells[7].textContent
                };
                event[selectedDate].push(rowData);

                // Appel de la fonction addToDataTable2 pour ajouter l'événement à dataTable2
                addToDataTable2(rowData);
            });

            alert('Agenda sauvegardé pour la date : ' + selectedDate);
        }

        function addToDataTable2(eventData) {
            const dataTable2 = document.querySelector('#dataTable2 tbody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${eventData.telefono}</td>
                <td>${eventData.nombre}</td>
                <td>${eventData.fecha}</td>
                <td>${eventData.hora}</td>
                <td>${eventData.min}</td>
                <td>${eventData.lugar}</td>
                <td>${eventData.precio}</td>
                <td>${eventData.travail}</td>
            `;
            dataTable2.appendChild(row);
        }

        // Générer le calendrier pour le mois et l'année actuels
        generateCalendar(currentMonth, currentYear);
    </script>
</body>
</html>
