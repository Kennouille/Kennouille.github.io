<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendrier et Agenda Quotidien</title>
    <link rel="stylesheet" href="calendrier.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
    <script type="module">
        import { supabase } from './supabaseClientAgendaJour.js';

        var currentMonth = new Date().getMonth();
        var currentYear = new Date().getFullYear();
        var event = {}; // Objet pour stocker les événements par date

        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];


        function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            generateCalendar(currentMonth, currentYear);
        }

        function generateCalendar(month, year) {
            console.log('generateCalendar called');
            const calendarTable = document.getElementById('calendarTable');
            const monthYearDisplay = document.getElementById('monthYear');
            calendarTable.innerHTML = `
                <tr>
                    <th>Lu</th>
                    <th>Ma</th>
                    <th>Mie</th>
                    <th>Ju</th>
                    <th>Vie</th>
                    <th>Sa</th>
                    <th>Do</th>
                </tr>
            `;

            // Mettre à jour l'affichage du mois et de l'année
            monthYearDisplay.textContent = `${monthNames[month]} ${year}`;

            const firstDay = (new Date(year, month).getDay() + 6) % 7;
            const daysInMonth = 32 - new Date(year, month, 32).getDate();
            let date = 1;

            for (let i = 0; i < 6; i++) {
                let row = document.createElement('tr');

                for (let j = 0; j < 7; j++) {
                    if (i === 0 && j < firstDay) {
                        let cell = document.createElement('td');
                        let cellText = document.createTextNode('');
                        cell.appendChild(cellText);
                        row.appendChild(cell);
                    } else if (date > daysInMonth) {
                        break;
                    } else {
                        let cell = document.createElement('td');
                        let cellText = document.createTextNode(date);
                        cell.classList.add('clickable');
                        cell.addEventListener('click', handleDateClick);
                        if (date === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear()) {
                            cell.classList.add('today');
                        }
                        cell.appendChild(cellText);
                        row.appendChild(cell);
                        date++;
                    }
                }

                calendarTable.appendChild(row);
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOMContentLoaded triggered');

            window.successMessage = document.getElementById('successMessage');
            console.log('successMessage element:', window.successMessage);

            // Définir la variable today
            var today = new Date();
            var todayDate = today.getDate();
            var todayMonth = today.getMonth();
            var todayYear = today.getFullYear();
            var todayFormatted = `${todayYear}-${String(todayMonth + 1).padStart(2, '0')}-${String(todayDate).padStart(2, '0')}`;

            // Générer le calendrier pour le mois et l'année actuels
            if (!window.isCalendarGenerated) {
                generateCalendar(currentMonth, currentYear);
                window.isCalendarGenerated = true;
            }

            // Sélectionner aujourd'hui
            if (!window.isTodaySelected) {
                selectToday();
                window.isTodaySelected = true;
            }

            // Simuler un clic sur la date actuelle pour appeler handleDateClick
            const cells = document.querySelectorAll('.clickable');
            cells.forEach(cell => {
                if (parseInt(cell.textContent) === todayDate && currentMonth === todayMonth && currentYear === todayYear) {
                    const event = new Event('click');
                    cell.dispatchEvent(event);
                }
            });

            // Ajouter des écouteurs d'événements pour les boutons
            document.getElementById('prevButton').addEventListener('click', function() {
                changeMonth(-1);
            });

            document.getElementById('nextButton').addEventListener('click', function() {
                changeMonth(1);

            // Gérer le clic sur une date
            document.querySelectorAll('.clickable').forEach(cell => {
                cell.addEventListener('click', handleDateClick);
            });
            });
        });

        document.getElementById('addEventButton').addEventListener('click', async function() {
            const telefono = document.getElementById('Telefono').value;
            const nombre = document.getElementById('Nombre').value;
            const fecha = document.getElementById('Fecha').value;
            const hora = document.getElementById('Hora').value;
            const min = document.getElementById('Min').value || null;
            const lugar = document.getElementById('Lugar').value || null;
            const precio = document.getElementById('Precio').value || null;
            const trabajo = document.getElementById('Trabajo').value || null;

            // Générer un UUID pour user_id
            const user_id = crypto.randomUUID();

            // Ajoutez des logs pour vérifier les valeurs
            console.log('Telefono:', telefono);
            console.log('Nombre:', nombre);
            console.log('Fecha:', fecha);
            console.log('Hora:', hora);
            console.log('Min:', min);
            console.log('Lugar:', lugar);
            console.log('Precio:', precio);
            console.log('Trabajo:', trabajo);
            console.log('user_id:', user_id);

            // Vérifier s'il existe une correspondance dans tableData1
            const { data: existingData, error: fetchError } = await supabase
                .from('tableData1')
                .select('*')
                .eq('Telefono', telefono);

            if (fetchError) {
                console.error('Erreur lors de la vérification de la correspondance :', fetchError);
                return;
            }

            if (existingData && existingData.length > 0) {
                // Mettre à jour les colonnes dans tableData1
                const { error: updateError } = await supabase
                    .from('tableData1')
                    .update({
                        Nombre: nombre || existingData[0].Nombre,
                        Fecha: fecha || existingData[0].Fecha,
                        Hora: hora || existingData[0].Hora,
                        Min: min || existingData[0].Min,
                        Lugar: lugar || existingData[0].Lugar,
                        Precio: precio || existingData[0].Precio,
                        Trabajo: trabajo || existingData[0].Trabajo,
                        env_datos: env_datos || existingData[0].env_datos,
                        factura: factura || existingData[0].factura,
                        pagado: pagado
                    })
                    .eq('Telefono', telefono);

                if (updateError) {
                    console.error('Erreur lors de la mise à jour de tableData1 :', updateError);
                    return;
                } else {
                    console.log('tableData1 mis à jour avec succès');
                }
            } else {
                // Insérer une nouvelle ligne dans tableData1
                const { error: insertErrorTableData1 } = await supabase
                    .from('tableData1')
                    .insert([{ Telefono: telefono, Nombre: nombre, Fecha: fecha, Hora: hora, Min: min, Lugar: lugar, Precio: precio, Trabajo: trabajo, env_datos: env_datos, factura: factura, pagado: pagado }]);

                if (insertErrorTableData1) {
                    console.error('Erreur lors de l\'ajout de la nouvelle ligne dans tableData1 :', insertErrorTableData1);
                    return;
                } else {
                    console.log('Nouvelle ligne ajoutée dans tableData1 avec succès');
                }
            }

            // Insérer les données dans event_quot1
            const { error: insertErrorEventQuot1 } = await supabase
                .from('event_quot1')
                .insert([{ Telefono: telefono, Nombre: nombre, Fecha: fecha, Hora: hora, Min: min, Lugar: lugar, Precio: precio, Trabajo: trabajo, Env_datos: env_datos, Factura: factura, Pagado: pagado, user_id: user_id }]);

            if (insertErrorEventQuot1) {
                console.error('Erreur lors de l\'ajout de l\'événement :', insertErrorEventQuot1);
            } else {
                console.log('Événement ajouté avec succès');
                // Effacer les champs du formulaire
                document.getElementById('Telefono').value = '';
                document.getElementById('Nombre').value = '';
                document.getElementById('Fecha').value = '';
                document.getElementById('Hora').value = '';
                document.getElementById('Min').value = '';
                document.getElementById('Lugar').value = '';
                document.getElementById('Precio').value = '';
                document.getElementById('Trabajo').value = '';
                document.getElementById('Env_datos').checked = false;
                document.getElementById('Pagado').checked = false;
                // Recharger les données du tableau
                loadTableData();
            }
        });

            let isCalendarGenerated = false;
            let isTodaySelected = false;


            document.getElementById('Telefono').addEventListener('input', async function() {
                const telefono = this.value;

                if (telefono) {
                    // Requête pour récupérer les données de tableData1 où Telefono correspond
                    const { data, error } = await supabase
                        .from('tableData1')
                        .select('Nombre, Lugar')
                        .eq('Telefono', telefono); // Comparer avec la colonne Telefono

                    if (error) {
                        console.error('Erreur lors de la récupération des données :', error);
                    } else if (data.length > 0) {
                        const { Nombre, Lugar } = data[0];
                        document.getElementById('Nombre').value = Nombre;
                        document.getElementById('Lugar').value = Lugar;
                    } else {
                        // Si aucun résultat n'est trouvé, vider les champs
                        document.getElementById('Nombre').value = '';
                        document.getElementById('Lugar').value = '';
                    }
                } else {
                    // Si le champ de téléphone est vide, vider les champs
                    document.getElementById('Nombre').value = '';
                    document.getElementById('Lugar').value = '';
                }
            });

        // Fonction pour récupérer les événements par date
        async function fetchEventsByDate(date) {
            if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) {
                console.error('Date format is incorrect. Expected format: YYYY-MM-DD');
                return;
            }
            console.log('fetchEventsByDate called for date:', date);
            try {
                const { data, error } = await supabase
                    .from('event_quot1')
                    .select('*')
                    .eq('Fecha', date);

                if (error) {
                    console.error('Erreur lors de la récupération des événements :', error);
                    return [];
                }

                // Définir l'ordre de tri pour les heures
                const horaOrder = ['9am', '10am', '11am', '12pm', '1pm', '2pm', '3pm', '4pm', '5pm', 'otro'];

                // Trier les événements par la colonne Hora
                data.sort((a, b) => {
                    return horaOrder.indexOf(a.Hora) - horaOrder.indexOf(b.Hora);
                });

                const tbody = document.querySelector('#editable-table tbody');
                tbody.innerHTML = ''; // Effacer les anciennes lignes

                data.forEach(event => {
                    const row = tbody.insertRow();
                    row.dataset.userId = event.user_id; // Ajouter l'attribut data-user-id

                    row.innerHTML = `
                        <td contenteditable="true" data-column="Telefono">${event.Telefono}</td>
                        <td contenteditable="true" data-column="Nombre">${event.Nombre}</td>
                        <td contenteditable="true" data-column="Fecha">${event.Fecha}</td>
                        <td contenteditable="true" data-column="Hora">${event.Hora}</td>
                        <td contenteditable="true" data-column="Min">${event.Min !== null ? event.Min : ''}</td>
                        <td contenteditable="true" data-column="Lugar">${event.Lugar !== null ? event.Lugar : ''}</td>
                        <td contenteditable="true" data-column="Precio">${event.Precio !== null ? event.Precio : ''}</td>
                        <td contenteditable="true" data-column="Trabajo">${event.Trabajo !== null ? event.Trabajo : ''}</td>
                        <td>
                            <div class="checkbox-container" style="font-size: smaller;">
                                <label>
                                    <input type="checkbox" data-column="Env_datos" ${event.Env_datos ? 'checked' : ''}> - Envié datos
                                </label>
                                <br>
                                <span class="factura-link" style="cursor: pointer; color: blue; text-decoration: underline;" data-factura="${event.Factura}">${event.Factura ? 'Voir la Facture' : 'Adjuntar Factura'}</span>
                                <br>
                                <label>
                                    <input type="checkbox" data-column="Pagado" ${event.Pagado ? 'checked' : ''}> - Pagado
                                </label>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);

                    // Ajoutez l'écouteur d'événement ici
                    const facturaLink = row.querySelector('.factura-link');
                    facturaLink.addEventListener('click', function(event) {
                        event.preventDefault();
                        console.log('Factura link clicked');
                        const facturaInput = row.querySelector('#facturaInput');
                        if (facturaInput) {
                            facturaInput.click();
                            // Ajouter un gestionnaire pour l'événement de changement de fichier
                            facturaInput.addEventListener('change', async function() {
                                const file = facturaInput.files[0];
                                if (file) {
                                    console.log('Fichier sélectionné:', file.name);
                                    // Télécharger le fichier sur Supabase
                                    const { data, error } = await supabase
                                        .storage
                                        .from('facturas') // Remplace 'facturas' par le nom de ton bucket de stockage
                                        .upload(`public/${file.name}`, file);

                                    if (error) {
                                        console.error('Erreur lors du téléchargement du fichier:', error);
                                    } else {
                                        console.log('Fichier téléchargé avec succès:', data);
                                        // Mettre à jour la base de données avec le lien du fichier
                                        const updatedEvent = {
                                            factura: data.Key // Utilise la clé du fichier téléchargé
                                        };
                                        const userId = row.dataset.userId;
                                        const { error: updateError } = await supabase
                                            .from('event_quot1')
                                            .update(updatedEvent)
                                            .eq('user_id', userId);

                                        if (updateError) {
                                            console.error('Erreur lors de la mise à jour de l\'événement :', updateError);
                                        } else {
                                            console.log('Événement mis à jour avec succès');
                                        }
                                    }
                                }
                            });
                        } else {
                            console.error('facturaInput not found');
                        }
                    });

                    // Ajouter la cellule pour le bouton "Aplicar cambio"
                    const applyCell = row.insertCell();
                    const applyButton = document.createElement('button');
                    applyButton.textContent = 'Aplicar cambio';
                    applyButton.classList.add('apply-button');
                    applyCell.appendChild(applyButton);

                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = 'Cancelar';
                    cancelButton.classList.add('cancel-button');
                    applyCell.appendChild(cancelButton);

                    const whatsappButton = document.createElement('button');
                    whatsappButton.textContent = 'WhatsApp';
                    whatsappButton.classList.add('whatsapp-button');
                    applyCell.appendChild(whatsappButton);

                    // Ajouter un écouteur d'événement au bouton "Aplicar cambio"
                    applyButton.addEventListener('click', async function() {
                        const updatedEvent = {};
                        Array.from(row.cells).forEach(cell => {
                            const column = cell.dataset.column;
                            if (column) {
                                const cellValue = cell.textContent.trim();
                                updatedEvent[column] = cellValue === '' ? null : cellValue;
                            }
                        });

                        // Capturer la valeur des cases à cocher séparément
                        const envDatosCheckbox = row.querySelector('[data-column="env_datos"]');
                        const facturaLink = row.querySelector('.factura-link');
                        const pagadoCheckbox = row.querySelector('[data-column="pagado"]');

                        if (envDatosCheckbox) {
                            updatedEvent['env_datos'] = envDatosCheckbox.checked;
                        } else {
                            console.error('Element for env_datos not found');
                        }

                        if (facturaLink) {
                            updatedEvent['factura'] = facturaLink.dataset.factura;
                        } else {
                            console.error('Element for factura not found');
                        }

                        if (pagadoCheckbox) {
                            updatedEvent['pagado'] = pagadoCheckbox.checked;
                        } else {
                            console.error('Element for pagado not found');
                        }

                        const telefono = updatedEvent['Telefono'];
                        const userId = row.dataset.userId;


                        if (telefono) {
                            // Mettre à jour les colonnes dans tableData1
                            const { error: updateError } = await supabase
                                .from('tableData1')
                                .update({
                                    Nombre: updatedEvent['Nombre'],
                                    Fecha: updatedEvent['Fecha'],
                                    Hora: updatedEvent['Hora'],
                                    Min: updatedEvent['Min'],
                                    Lugar: updatedEvent['Lugar'],
                                    Precio: updatedEvent['Precio'],
                                    Trabajo: updatedEvent['Trabajo'],
                                    env_datos: updatedEvent['env_datos'],
                                    factura: updatedEvent['factura'],
                                    pagado: updatedEvent['pagado']
                                })
                                .eq('Telefono', telefono);

                            if (updateError) {
                                console.error('Erreur lors de la mise à jour de tableData1 :', updateError);
                                return;
                            } else {
                                console.log('tableData1 mis à jour avec succès');
                            }

                            // Mettre à jour event_quot1
                            const userId = row.dataset.userId;
                            const { data, error } = await supabase
                                .from('event_quot1')
                                .update(updatedEvent)
                                .eq('user_id', userId);

                            if (error) {
                                console.error('Erreur lors de la mise à jour des données :', error);
                            } else {
                                console.log('Données mises à jour avec succès');
                                // Afficher le message de succès
                                window.successMessage.style.display = 'block';

                                // Masquer le message après 1 seconde
                                setTimeout(() => {
                                    window.successMessage.style.display = 'none';
                                }, 1000);
                            }
                        }
                    });

                    // Ajouter un écouteur d'événement au bouton "Cancelar"
                    cancelButton.addEventListener('click', function() {
                        // Afficher le popup de confirmation
                        const confirmationPopup = document.getElementById('confirmationPopup');
                        confirmationPopup.style.display = 'block';

                        // Ajouter des écouteurs d'événement aux boutons du popup
                        document.getElementById('confirmYes').addEventListener('click', async function() {
                            const telefono = row.querySelector('[data-column="Telefono"]').textContent.trim();
                            const userId = row.dataset.userId;

                            if (userId) {
                                // Supprimer la ligne dans event_quot1
                                const { error: deleteErrorEventQuot1 } = await supabase
                                    .from('event_quot1')
                                    .delete()
                                    .eq('user_id', userId);

                                if (deleteErrorEventQuot1) {
                                    console.error('Erreur lors de la suppression de la ligne dans event_quot1 :', deleteErrorEventQuot1);
                                    return;
                                } else {
                                    console.log('Ligne supprimée dans event_quot1 avec succès');
                                }
                            }

                            if (telefono) {
                                const { error: updateErrorTableData1 } = await supabase
                                    .from('tableData1')
                                    .update({
                                        Hora: null,
                                        Min: null,
                                        Precio: null,
                                        Trabajo: null,
                                        Env_datos: null,
                                        Factura: null,
                                        Pagado: null
                                    })
                                    .eq('Telefono', telefono);

                                if (updateErrorTableData1) {
                                    console.error('Erreur lors de la mise à jour de tableData1 :', updateErrorTableData1);
                                    return;
                                } else {
                                    console.log('Colonnes effacées dans tableData1 avec succès');
                                }
                            }

                            // Supprimer la ligne du tableau
                            row.remove();

                            // Afficher le message de succès "Cancelado"
                            window.successMessage.textContent = 'Cancelado';
                            window.successMessage.style.display = 'block';

                            // Masquer le message après 1 seconde
                            setTimeout(() => {
                                window.successMessage.style.display = 'none';
                                window.successMessage.textContent = 'Données mises à jour avec succès'; // Réinitialiser le texte du message de succès
                            }, 1000);

                            // Masquer le popup de confirmation
                            confirmationPopup.style.display = 'none';
                        });

                        document.getElementById('confirmNo').addEventListener('click', function() {
                            // Masquer le popup de confirmation
                            confirmationPopup.style.display = 'none';
                        });
                    });

                    // Ajouter un écouteur d'événement au bouton "WhatsApp"
                    whatsappButton.addEventListener('click', function() {
                        const telefono = row.querySelector('[data-column="Telefono"]').textContent.trim();
                        if (telefono) {
                            const whatsappUrl = `https://api.whatsapp.com/send?phone=${telefono}`;
                            window.open(whatsappUrl, '_blank');
                        }
                    });
                });

                return data;
            } catch (error) {
                console.error('Erreur lors de la récupération des événements :', error);
                return [];
            }
        }

        // Fonction pour gérer le clic sur une date
        async function handleDateClick(event) {
            const clickedDate = event.target.textContent;
            const selectedDate = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(clickedDate).padStart(2, '0')}`;
            document.getElementById('Fecha').value = selectedDate;

            // Mettre à jour l'affichage de la date sélectionnée
            const selectedDateDisplay = document.getElementById('selectedDateDisplay');
            // selectedDateDisplay.textContent = `Fecha seleccionada : ${new Date(selectedDate).toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' })}`;

            // Mettre en surbrillance la date sélectionnée dans le calendrier
            document.querySelectorAll('.clickable').forEach(cell => {
                cell.classList.remove('selected');
            });

            // Ajouter la classe 'selected' à la cellule cliquée
            event.target.classList.add('selected');

            try {
                // Récupérer les événements pour la date sélectionnée
                const { data: events, error } = await supabase
                    .from('event_quot1')
                    .select('*')
                    .eq('Fecha', selectedDate);

                if (error) {
                    console.error('Erreur lors de la récupération des événements :', error);
                    return;
                }

                // Définir l'ordre de tri pour les heures
                const horaOrder = ['9am', '10am', '11am', '12pm', '1pm', '2pm', '3pm', '4pm', '5pm', 'otro'];

                // Trier les événements par la colonne Hora
                events.sort((a, b) => {
                    return horaOrder.indexOf(a.Hora) - horaOrder.indexOf(b.Hora);
                });

                // Afficher les événements dans le tableau editable-table
                const tableBody = document.querySelector('#editable-table tbody');
                tableBody.innerHTML = ''; // Effacer les anciennes lignes

                events.forEach(event => {
                    const row = document.createElement('tr');
                    row.dataset.userId = event.user_id; // Assurez-vous que l'ID utilisateur est défini
                    row.innerHTML = `
                        <td contenteditable="true" data-column="Telefono">${event.Telefono}</td>
                        <td contenteditable="true" data-column="Nombre">${event.Nombre}</td>
                        <td contenteditable="true" data-column="Fecha">${event.Fecha}</td>
                        <td contenteditable="true" data-column="Hora">${event.Hora}</td>
                        <td contenteditable="true" data-column="Min">${event.Min !== null ? event.Min : ''}</td>
                        <td contenteditable="true" data-column="Lugar">${event.Lugar !== null ? event.Lugar : ''}</td>
                        <td contenteditable="true" data-column="Precio">${event.Precio !== null ? event.Precio : ''}</td>
                        <td contenteditable="true" data-column="Trabajo">${event.Trabajo !== null ? event.Trabajo : ''}</td>
                        <td>
                            <div class="checkbox-container" style="font-size: smaller;">
                                <label>
                                    <input type="checkbox" data-column="env_datos" ${event.env_datos ? 'checked' : ''}> - Envié datos
                                </label>
                                <br>
                                <span class="factura-link" style="cursor: pointer; color: blue; text-decoration: underline;" data-factura="${event.Factura}">${event.Factura ? 'Voir la Facture' : 'Adjuntar Factura'}</span>
                                <br>
                                <label>
                                    <input type="checkbox" data-column="pagado" ${event.pagado ? 'checked' : ''}> - Pagado
                                </label>
                                <input type="file" id="facturaInput" style="display: none;">
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);

                    // Récupérer l'URL de l'image
                    if (event.Factura) {
                        const { data: imageURL, error: imageError } = await supabase
                            .storage
                            .from('facturas') // Remplace 'facturas' par le nom de ton bucket de stockage
                            .getPublicUrl(event.Factura);

                        if (imageError) {
                            console.error('Erreur lors de la récupération de l\'image :', imageError);
                        } else {
                            // Ajouter l'écouteur d'événement pour afficher l'image
                            const facturaLink = row.querySelector('.factura-link');
                            facturaLink.addEventListener('click', function(event) {
                                event.preventDefault();
                                console.log('Factura link clicked, image URL:', imageURL.publicUrl);

                                // Afficher l'image dans un popup
                                const imagePopup = window.open("", "Image", "width=600,height=400");
                                imagePopup.document.write(`<img src="${imageURL.publicUrl}" alt="Facture">`);
                            });
                        }
                    } else {
                        console.error('Aucune facture trouvée');
                    }

                    // Ajouter l'écouteur d'événement pour télécharger une nouvelle facture
                    const facturaLink = row.querySelector('.factura-link');
                    facturaLink.addEventListener('click', function(event) {
                        event.preventDefault();
                        console.log('Factura link clicked');
                        const facturaInput = row.querySelector('#facturaInput');
                        if (facturaInput) {
                            facturaInput.click();
                            // Ajouter un gestionnaire pour l'événement de changement de fichier
                            facturaInput.addEventListener('change', async function() {
                                const file = facturaInput.files[0];
                                if (file) {
                                    console.log('Fichier sélectionné:', file.name);
                                    // Télécharger le fichier sur Supabase
                                    const { data, error } = await supabase
                                        .storage
                                        .from('facturas') // Remplace 'facturas' par le nom de ton bucket de stockage
                                        .upload(`public/${file.name}`, file);

                                    if (error) {
                                        console.error('Erreur lors du téléchargement du fichier:', error);
                                    } else {
                                        console.log('Fichier téléchargé avec succès:', data);
                                        // Mettre à jour la base de données avec le lien du fichier
                                        const updatedEvent = {
                                            factura: data.Key // Utilise la clé du fichier téléchargé
                                        };
                                        const userId = row.dataset.userId;
                                        const { error: updateError } = await supabase
                                            .from('event_quot1')
                                            .update(updatedEvent)
                                            .eq('user_id', userId);

                                        if (updateError) {
                                            console.error('Erreur lors de la mise à jour de l\'événement :', updateError);
                                        } else {
                                            console.log('Événement mis à jour avec succès');
                                        }
                                    }
                                }
                            });
                        } else {
                            console.error('facturaInput not found');
                        }
                    });

                    // Ajouter la cellule pour le bouton "Aplicar cambio"
                    const applyCell = row.insertCell();
                    const applyButton = document.createElement('button');
                    applyButton.textContent = 'Aplicar cambio';
                    applyButton.classList.add('apply-button');
                    applyCell.appendChild(applyButton);

                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = 'Cancelar';
                    cancelButton.classList.add('cancel-button');
                    applyCell.appendChild(cancelButton);

                    const whatsappButton = document.createElement('button');
                    whatsappButton.textContent = 'WhatsApp';
                    whatsappButton.classList.add('whatsapp-button');
                    applyCell.appendChild(whatsappButton);

                    // Ajouter un écouteur d'événement au bouton "Aplicar cambio"
                    applyButton.addEventListener('click', async function() {
                        const updatedEvent = {};
                        Array.from(row.cells).forEach(cell => {
                            const column = cell.dataset.column;
                            if (column) {
                                const cellValue = cell.textContent.trim();
                                updatedEvent[column] = cellValue === '' ? null : cellValue;
                            }
                        });

                        // Capturer la valeur des cases à cocher séparément
                        const envDatosCheckbox = row.querySelector('[data-column="env_datos"]');
                        const facturaLink = row.querySelector('.factura-link');
                        const pagadoCheckbox = row.querySelector('[data-column="pagado"]');

                        if (envDatosCheckbox) {
                            updatedEvent['env_datos'] = envDatosCheckbox.checked;
                        } else {
                            console.error('Element for env_datos not found');
                        }

                        if (facturaLink) {
                            updatedEvent['factura'] = facturaLink.dataset.factura;
                        } else {
                            console.error('Element for factura not found');
                        }

                        if (pagadoCheckbox) {
                            updatedEvent['pagado'] = pagadoCheckbox.checked;
                        } else {
                            console.error('Element for pagado not found');
                        }

                        const telefono = updatedEvent['Telefono'];
                        const userId = row.dataset.userId;

                        if (telefono) {
                            // Mettre à jour les colonnes dans tableData1
                            const { error: updateError } = await supabase
                                .from('tableData1')
                                .update({
                                    Nombre: updatedEvent['Nombre'],
                                    Fecha: updatedEvent['Fecha'],
                                    Hora: updatedEvent['Hora'],
                                    Min: updatedEvent['Min'],
                                    Lugar: updatedEvent['Lugar'],
                                    Precio: updatedEvent['Precio'],
                                    Trabajo: updatedEvent['Trabajo'],
                                    env_datos: updatedEvent['env_datos'],
                                    factura: updatedEvent['factura'],
                                    pagado: updatedEvent['pagado']
                                })
                                .eq('Telefono', telefono);

                            if (updateError) {
                                console.error('Erreur lors de la mise à jour de tableData1 :', updateError);
                                return;
                            } else {
                                console.log('tableData1 mis à jour avec succès');
                            }

                            // Mettre à jour event_quot1
                            const userId = row.dataset.userId;
                            const { data, error } = await supabase
                                .from('event_quot1')
                                .update(updatedEvent)
                                .eq('user_id', userId);

                            if (error) {
                                console.error('Erreur lors de la mise à jour des données :', error);
                            } else {
                                console.log('Données mises à jour avec succès');
                                // Afficher le message de succès
                                window.successMessage.style.display = 'block';

                                // Masquer le message après 1 seconde
                                setTimeout(() => {
                                    window.successMessage.style.display = 'none';
                                }, 1000);
                            }
                        }
                    });

                    // Ajouter un écouteur d'événement au bouton "Cancelar"
                    cancelButton.addEventListener('click', function() {
                        // Afficher le popup de confirmation
                        const confirmationPopup = document.getElementById('confirmationPopup');
                        confirmationPopup.style.display = 'block';

                        // Ajouter des écouteurs d'événement aux boutons du popup
                        document.getElementById('confirmYes').addEventListener('click', async function() {
                            const telefono = row.querySelector('[data-column="Telefono"]').textContent.trim();
                            const userId = row.dataset.userId;

                            if (userId) {
                                // Supprimer la ligne dans event_quot1
                                const { error: deleteErrorEventQuot1 } = await supabase
                                    .from('event_quot1')
                                    .delete()
                                    .eq('user_id', userId);

                                if (deleteErrorEventQuot1) {
                                    console.error('Erreur lors de la suppression de la ligne dans event_quot1 :', deleteErrorEventQuot1);
                                    return;
                                } else {
                                    console.log('Ligne supprimée dans event_quot1 avec succès');
                                }
                            }

                            if (telefono) {
                                // Effacer les colonnes Hora, Min, Precio et Trabajo dans tableData1
                                const { error: updateErrorTableData1 } = await supabase
                                    .from('tableData1')
                                    .update({
                                        Hora: null,
                                        Min: null,
                                        Precio: null,
                                        Trabajo: null,
                                        Env_datos: null,
                                        Factura: null,
                                        Pagado: null
                                    })
                                    .eq('Telefono', telefono);

                                if (updateErrorTableData1) {
                                    console.error('Erreur lors de la mise à jour de tableData1 :', updateErrorTableData1);
                                    return;
                                } else {
                                    console.log('Colonnes effacées dans tableData1 avec succès');
                                }
                            }

                            // Supprimer la ligne du tableau
                            row.remove();

                            // Afficher le message de succès "Cancelado"
                            window.successMessage.textContent = 'Cancelado';
                            window.successMessage.style.display = 'block';

                            // Masquer le message après 1 seconde
                            setTimeout(() => {
                                window.successMessage.style.display = 'none';
                                window.successMessage.textContent = 'Données mises à jour avec succès'; // Réinitialiser le texte du message de succès
                            }, 1000);

                            // Masquer le popup de confirmation
                            confirmationPopup.style.display = 'none';
                        });

                        document.getElementById('confirmNo').addEventListener('click', function() {
                            // Masquer le popup de confirmation
                            confirmationPopup.style.display = 'none';
                        });
                    });

                    // Ajouter un écouteur d'événement au bouton "WhatsApp"
                    whatsappButton.addEventListener('click', function() {
                        const telefono = row.querySelector('[data-column="Telefono"]').textContent.trim();
                        if (telefono) {
                            const whatsappUrl = `https://api.whatsapp.com/send?phone=${telefono}`;
                            window.open(whatsappUrl, '_blank');
                        }
                    });
                });

            } catch (error) {
                console.error('Erreur lors de la récupération des événements :', error);
            }
        }

        // Ajoutez un écouteur d'événements pour chaque cellule cliquable
        document.querySelectorAll('.clickable').forEach(cell => {
            cell.addEventListener('click', handleDateClick);
        });

        // Attacher handleDateClick aux cellules du calendrier
        document.querySelectorAll('.clickable').forEach(cell => {
            cell.addEventListener('click', handleDateClick);
        });


        // Fonction pour charger les données de la table
        async function loadTableData() {
            console.log('loadTableData called');
            const today = new Date().toISOString().split('T')[0]; // Obtenir la date d'aujourd'hui au format YYYY-MM-DD
            console.log('Date passed to fetchEventsByDate from loadTableData:', today);
            await fetchEventsByDate(today);
        }

        function getHourOrder(hour) {
            const hourOrder = {
                "9am": 1,
                "10am": 2,
                "11am": 3,
                "12pm": 4,
                "1pm": 5,
                "2pm": 6,
                "3pm": 7,
                "4pm": 8,
                "5pm": 9,
                "otro": 10
            };
            return hourOrder[hour] || 11; // Retourne 11 pour les heures non définies
        }


        function selectToday() {
            const today = new Date();
            const todayDate = today.getDate();
            const todayMonth = today.getMonth();
            const todayYear = today.getFullYear();

            const selectedDate = `${todayYear}-${String(todayMonth + 1).padStart(2, '0')}-${String(todayDate).padStart(2, '0')}`;
            document.getElementById('Fecha').value = selectedDate;

            if (!/^\d{4}-\d{2}-\d{2}$/.test(selectedDate)) {
                console.error('Date format is incorrect. Expected format: YYYY-MM-DD');
                return;
            }

            // Mettre en surbrillance la date du jour dans le calendrier
            document.querySelectorAll('.clickable').forEach(cell => {
                cell.classList.remove('selected');
                if (parseInt(cell.textContent) === todayDate && todayMonth === currentMonth && todayYear === currentYear) {
                    cell.classList.add('selected');
                }
            });

            console.log('Date passed to fetchEventsByDate from selectToday:', selectedDate);
        }


        window.onload = function() {
            generateCalendar(currentMonth, currentYear);
            selectToday();
        }


        function saveDate() {
            const selectedDateDisplay = document.getElementById('selectedDateDisplay');
            const selectedDate = selectedDateDisplay.textContent.split(' : ')[1];
            const tableBody = document.querySelector('#editable-table tbody');
            const rows = tableBody.querySelectorAll('tr');

            event[selectedDate] = [];
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = {
                    telefono: cells[0].textContent,
                    nombre: cells[1].textContent,
                    fecha: cells[2].textContent,
                    hora: cells[3].textContent,
                    min: cells[4].textContent,
                    lugar: cells[5].textContent,
                    precio: cells[6].textContent,
                    travail: cells[7].textContent,
                    env_datos: cells[8].querySelector('[data-column="Env_datos"]').checked,
                    factura: cells[8].querySelector('.factura-link').dataset.factura,
                    pagado: cells[8].querySelector('[data-column="Pagado"]').checked
                };
                event[selectedDate].push(rowData);

            });

            alert('Agenda sauvegardé pour la date : ' + selectedDate);
        }

        // Générer le calendrier pour le mois et l'année actuels
        generateCalendar(currentMonth, currentYear);
        selectToday();


        async function updateCheckbox(event) {
            const row = event.target.closest('tr');
            const column = event.target.dataset.column;
            const value = event.target.checked;
            const userId = row.dataset.userId;

            const { error } = await supabase
                .from('event_quot1')
                .update({ [column]: value })
                .eq('user_id', userId);

            if (error) {
                console.error(`Erreur lors de la mise à jour de la colonne ${column} :`, error);
            } else {
                console.log(`Colonne ${column} mise à jour avec succès`);
            }
        }

        async function openFacturaDialog(event) {
            const facturaLink = event.target;
            const userId = facturaLink.closest('tr').dataset.userId;

            if (facturaLink.textContent === 'Ajouter Factura') {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.addEventListener('change', async function() {
                    const file = input.files[0];
                    if (file) {
                        const { data, error } = await supabase
                            .storage
                            .from('facturas')
                            .upload(`${userId}/${file.name}`, file);

                        if (error) {
                            console.error('Erreur lors du téléchargement de la facture :', error);
                        } else {
                            console.log('Facture téléchargée avec succès');
                            facturaLink.textContent = 'Voir la Facture';
                            facturaLink.dataset.factura = data.Key;

                            // Mettre à jour la base de données
                            const { error: updateError } = await supabase
                                .from('event_quot1')
                                .update({ Factura: data.Key })
                                .eq('user_id', userId);

                            if (updateError) {
                                console.error('Erreur lors de la mise à jour de la colonne Factura :', updateError);
                            } else {
                                console.log('Colonne Factura mise à jour avec succès');
                            }
                        }
                    }
                });
                input.click();
            } else {
                const { publicURL, error } = supabase.storage.from('facturas').getPublicUrl(facturaLink.dataset.factura);
                if (error) {
                    console.error('Erreur lors de la récupération de l\'URL publique de la facture :', error);
                } else {
                    window.open(publicURL, '_blank');
                }
            }
        }

    </script>
</head>

<body>
    <div class="main-container">
        <h1>Calendario y Agenda</h1>
        <div class="navigation-container">
            <button id="prevButton" class="button">Anterior</button>
            <span id="monthYear"></span>
            <button id="nextButton" class="button">Siguiente</button>
        </div>
        <div class="calendar-container">
            <table id="calendarTable">
                <tr>
                    <th>Lu</th>
                    <th>Ma</th>
                    <th>Mie</th>
                    <th>Ju</th>
                    <th>Vie</th>
                    <th>Sa</th>
                    <th>Do</th>
                </tr>
            </table>
        </div>
        <div class="editable-container">
            <table id="editable-table">
                <thead>
                    <tr>
                        <th>Telefono</th>
                        <th>Nombre</th>
                        <th>Fecha</th>
                        <th>Hora</th>
                        <th>Min</th>
                        <th>Lugar</th>
                        <th>Precio</th>
                        <th>Trabajo</th>
                        <th>Facturación</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td>
                            <div class="checkbox-container" style="font-size: smaller;">
                                <label>
                                    <input type="checkbox" data-column="env_datos" ${event.env_datos ? 'checked' : ''}> - Envié datos
                                </label>
                                <br>
                                <span class="factura-link" style="cursor: pointer; color: blue; text-decoration: underline;" data-factura="${event.Factura}">${event.Factura ? 'Voir la Facture' : 'Adjuntar Factura'}</span>
                                <br>
                                <label>
                                    <input type="checkbox" data-column="pagado" ${event.pagado ? 'checked' : ''}> - Pagado
                                </label>
                                <input type="file" id="facturaInput" style="display: none;">
                            </div>
                        </td>
                    </tr>
                    <!-- Ajoutez plus de lignes si nécessaire -->
                </tbody>
            </table>

        </div>
        <div class="form-container">
            <h2>Nuevo evento</h2>
            <input type="text" id="Telefono" placeholder="Telefono">
            <input type="text" id="Nombre" placeholder="Nombre">
            <input type="date" id="Fecha">
            <select id="Hora">
                <option value="9am">9am</option>
                <option value="10am">10am</option>
                <option value="11am">11am</option>
                <option value="12pm">12pm</option>
                <option value="1pm">1pm</option>
                <option value="2pm">2pm</option>
                <option value="3pm">3pm</option>
                <option value="4pm">4pm</option>
                <option value="5pm">5pm</option>
                <option value="otro">Otro</option>
            </select>
            <input type="number" id="Min" placeholder="Min">
            <input type="text" id="Lugar" placeholder="Lugar">
            <input type="number" id="Precio" placeholder="Precio">
            <input type="text" id="Trabajo" placeholder="Trabajo">
            <button id="addEventButton" class="button">Adjuntar un evento</button>
        </div>
        <div id="successMessage" class="hidden">Guardado</div>
        <div id="confirmationPopup" class="popup">
            <div class="popup-content">
                <p>Está seguro?</p>
                <button id="confirmYes" class="button">Sí</button>
                <button id="confirmNo" class="button">No</button>
            </div>
        </div>
    </div>
</body>
</html>