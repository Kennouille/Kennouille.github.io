<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendrier et Agenda Quotidien</title>
    <link rel="stylesheet" href="calendrier.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
</head>
<body>
    <div class="main-container">
        <h1>Calendario y Agenda</h1>
        <div class="navigation-container">
            <button class="button" onclick="changeMonth(-1)">Precedente</button>
            <span id="monthYear"></span>
            <button class="button" onclick="changeMonth(1)">Siguiente</button>
        </div>
        <div class="calendar-container">
            <table id="calendarTable">
                <tr>
                    <th>Lu</th>
                    <th>Ma</th>
                    <th>Mie</th>
                    <th>Ju</th>
                    <th>Vie</th>
                    <th>Sa</th>
                    <th>Do</th>
                </tr>
            </table>
        </div>
        <div class="editable-container">
            <span id="selectedDateDisplay">Fecha seleccionada : </span>
            <table id="editable-table">
                <thead>
                    <tr>
                        <th>Telefono</th>
                        <th>Nombre</th>
                        <th>Fecha</th>
                        <th>Hora</th>
                        <th>Min</th>
                        <th>Lugar</th>
                        <th>Precio</th>
                        <th>Trabajo</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                    </tr>
                    <!-- Ajoutez plus de lignes si nécessaire -->
                </tbody>
            </table>
        </div>
        <div class="form-container">
            <h2>Nuevo evento</h2>
            <input type="text" id="Telefono" placeholder="Telefono">
            <input type="text" id="Nombre" placeholder="Nombre">
            <input type="date" id="Fecha">
            <select id="Hora">
                <option value="9am">9am</option>
                <option value="10am">10am</option>
                <option value="11am">11am</option>
                <option value="12pm">12pm</option>
                <option value="1pm">1pm</option>
                <option value="2pm">2pm</option>
                <option value="3pm">3pm</option>
                <option value="4pm">4pm</option>
                <option value="5pm">5pm</option>
                <option value="otro">Otro</option>
            </select>
            <input type="number" id="Min" placeholder="Min">
            <input type="text" id="Lugar" placeholder="Lugar">
            <input type="number" id="Precio" placeholder="Precio">
            <input type="text" id="Trabajo" placeholder="Trabajo">
            <button id="addEventButton" class="button">Adjuntar un evento</button>
        </div>
    </div>
    <script type="module">
        import { supabase } from './supabaseClientAgendaJour.js';

        var currentMonth = new Date().getMonth();
        var currentYear = new Date().getFullYear();
        var event = {}; // Objet pour stocker les événements par date

        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        async function fetchEventsByDate(date) {
            try {
                const { data, error } = await supabase
                    .from('event_quot1')
                    .select('*')
                    .eq('Fecha', date);

                if (error) {
                    console.error('Erreur lors de la récupération des événements :', error);
                    return [];
                }

                return data;
            } catch (error) {
                console.error('Erreur lors de la récupération des événements :', error);
                return [];
            }
        }

        async function loadTableData() {
            try {
                const { data, error } = await supabase
                    .from('event_quot1')
                    .select('*');

                if (error) {
                    console.error('Error fetching data:', error);
                    return;
                }

                const tableBody = document.querySelector('#editable-table tbody');
                tableBody.innerHTML = ''; // Clear existing table data

                data.forEach(event => {
                    const row = document.createElement('tr');
                    row.dataset.userId = event.user_id; // Assurez-vous que l'ID utilisateur est défini
                    row.innerHTML = `
                        <td contenteditable="true" data-column="Telefono">${event.Telefono}</td>
                        <td contenteditable="true" data-column="Nombre">${event.Nombre}</td>
                        <td contenteditable="true" data-column="Fecha">${event.Fecha}</td>
                        <td contenteditable="true" data-column="Hora">${event.Hora}</td>
                        <td contenteditable="true" data-column="Min">${event.Min}</td>
                        <td contenteditable="true" data-column="Lugar">${event.Lugar}</td>
                        <td contenteditable="true" data-column="Precio">${event.Precio}</td>
                        <td contenteditable="true" data-column="Trabajo">${event.Trabajo}</td>
                    `;
                    tableBody.appendChild(row);

                    // Ajouter le bouton "Appliquer"
                    const applyCell = row.insertCell();
                    const applyButton = document.createElement('button');
                    applyButton.textContent = 'Aplicar';
                    applyButton.classList.add('apply-button');
                    applyCell.appendChild(applyButton);
                });

                addEmptyRow(); // Ajouter une ligne vide

                // Ajouter des écouteurs d'événements aux boutons "Appliquer"
                document.querySelectorAll('.apply-button').forEach(button => {
                    button.addEventListener('click', async function() {
                        const row = button.closest('tr');
                        const updatedEvent = {};
                        Array.from(row.cells).forEach(cell => {
                            if (cell.dataset.column) {
                                updatedEvent[cell.dataset.column] = cell.textContent.trim();
                            }
                        });

                        const userId = row.dataset.userId;

                        const { error } = await supabase
                            .from('event_quot1')
                            .update(updatedEvent)
                            .eq('user_id', userId);

                        if (error) {
                            console.error('Erreur lors de la mise à jour des données :', error);
                        } else {
                            console.log('Données mises à jour avec succès');
                        }
                    });
                });
            } catch (err) {
                console.error('Error loading Supabase client:', err);
            }
        }


        async function handleDateClick(event) {
            const clickedDate = event.target.textContent;
            const selectedDate = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(clickedDate).padStart(2, '0')}`;
            document.getElementById('Fecha').value = selectedDate;

            // Mettre à jour l'affichage de la date sélectionnée
            const selectedDateDisplay = document.getElementById('selectedDateDisplay');
            selectedDateDisplay.textContent = `Date sélectionnée : ${new Date(selectedDate).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' })}`;

            // Récupérer les événements pour la date sélectionnée
            const events = await fetchEventsByDate(selectedDate);

            // Trier les événements par heure
            events.sort((a, b) => getHourOrder(a.Hora) - getHourOrder(b.Hora));

            // Afficher les événements dans le tableau editable-table
            const tableBody = document.querySelector('#editable-table tbody');
            tableBody.innerHTML = ''; // Effacer les anciennes lignes

            events.forEach(event => {
                const row = document.createElement('tr');
                row.dataset.userId = event.user_id; // Assurez-vous que l'ID utilisateur est défini
                row.innerHTML = `
                    <td contenteditable="true" data-column="Telefono">${event.Telefono}</td>
                    <td contenteditable="true" data-column="Nombre">${event.Nombre}</td>
                    <td contenteditable="true" data-column="Fecha">${event.Fecha}</td>
                    <td contenteditable="true" data-column="Hora">${event.Hora}</td>
                    <td contenteditable="true" data-column="Min">${event.Min}</td>
                    <td contenteditable="true" data-column="Lugar">${event.Lugar}</td>
                    <td contenteditable="true" data-column="Precio">${event.Precio}</td>
                    <td contenteditable="true" data-column="Trabajo">${event.Trabajo}</td>
                `;
                tableBody.appendChild(row);

                // Ajouter le bouton "Appliquer"
                const applyCell = row.insertCell();
                const applyButton = document.createElement('button');
                applyButton.textContent = 'Aplicar';
                applyButton.classList.add('apply-button');
                applyCell.appendChild(applyButton);
            });

            // Ajouter des écouteurs d'événements aux boutons "Appliquer"
            document.querySelectorAll('.apply-button').forEach(button => {
                button.addEventListener('click', async function() {
                    const row = button.closest('tr');
                    const updatedEvent = {};
                    Array.from(row.cells).forEach(cell => {
                        if (cell.dataset.column) {
                            updatedEvent[cell.dataset.column] = cell.textContent.trim();
                        }
                    });

                    const userId = row.dataset.userId;

                    const { error } = await supabase
                        .from('event_quot1')
                        .update(updatedEvent)
                        .eq('user_id', userId);

                    if (error) {
                        console.error('Erreur lors de la mise à jour des données :', error);
                    } else {
                        console.log('Données mises à jour avec succès');
                    }
                });
            });

            // Retirer la classe 'selected' de toutes les dates
            document.querySelectorAll('.clickable').forEach(cell => {
                cell.classList.remove('selected');
            });

            // Ajouter la classe 'selected' à la date cliquée
            event.target.classList.add('selected');
        }


        function getHourOrder(hour) {
            const hourOrder = {
                "9am": 1,
                "10am": 2,
                "11am": 3,
                "12pm": 4,
                "1pm": 5,
                "2pm": 6,
                "3pm": 7,
                "4pm": 8,
                "5pm": 9,
                "otro": 10
            };
            return hourOrder[hour] || 11; // Retourne 11 pour les heures non définies
        }

        function generateCalendar(month, year) {
            const calendarTable = document.getElementById('calendarTable');
            const monthYearDisplay = document.getElementById('monthYear');
            calendarTable.innerHTML = `
                <tr>
                    <th>Lu</th>
                    <th>Ma</th>
                    <th>Mie</th>
                    <th>Ju</th>
                    <th>Vie</th>
                    <th>Sa</th>
                    <th>Do</th>
                </tr>
            `;

            const firstDay = (new Date(year, month).getDay() + 6) % 7; // Ajustement pour commencer par lundi
            const daysInMonth = 32 - new Date(year, month, 32).getDate();
            let date = 1;

            for (let i = 0; i < 6; i++) {
                let row = document.createElement('tr');

                for (let j = 0; j < 7; j++) {
                    if (i === 0 && j < firstDay) {
                        let cell = document.createElement('td');
                        let cellText = document.createTextNode('');
                        cell.appendChild(cellText);
                        row.appendChild(cell);
                    } else if (date > daysInMonth) {
                        break;
                    } else {
                        let cell = document.createElement('td');
                        let cellText = document.createTextNode(date);
                        cell.classList.add('clickable');
                        cell.addEventListener('click', handleDateClick);
                        if (date === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear()) {
                            cell.classList.add('today');
                        }
                        cell.appendChild(cellText);
                        row.appendChild(cell);
                        date++;
                    }
                }

                calendarTable.appendChild(row);
            }

            monthYearDisplay.textContent = monthNames[month] + ' ' + year;
        }

        function selectToday() {
            const today = new Date();
            const todayDate = today.getDate();
            const todayMonth = today.getMonth();
            const todayYear = today.getFullYear();

            const selectedDate = `${todayYear}-${String(todayMonth + 1).padStart(2, '0')}-${String(todayDate).padStart(2, '0')}`;
            document.getElementById('Fecha').value = selectedDate;

            // Mettre à jour l'affichage de la date sélectionnée
            const selectedDateDisplay = document.getElementById('selectedDateDisplay');
            selectedDateDisplay.textContent = `Fecha seleccionada : ${new Date(selectedDate).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' })}`;

            // Récupérer et afficher les événements du jour
            fetchEventsByDate(selectedDate).then(events => {
                // Trier les événements par heure
                events.sort((a, b) => getHourOrder(a.Hora) - getHourOrder(b.Hora));

                // Afficher les événements dans le tableau editable-table
                const tableBody = document.querySelector('#editable-table tbody');
                tableBody.innerHTML = ''; // Effacer les anciennes lignes

                events.forEach(event => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td contenteditable="true">${event.Telefono}</td>
                        <td contenteditable="true">${event.Nombre}</td>
                        <td contenteditable="true">${event.Fecha}</td>
                        <td contenteditable="true">${event.Hora}</td>
                        <td contenteditable="true">${event.Min}</td>
                        <td contenteditable="true">${event.Lugar}</td>
                        <td contenteditable="true">${event.Precio}</td>
                        <td contenteditable="true">${event.Trabajo}</td>
                    `;
                    tableBody.appendChild(row);

                    // Ajouter le bouton "Appliquer"
                    const applyCell = row.insertCell();
                    const applyButton = document.createElement('button');
                    applyButton.textContent = 'Aplicar';
                    applyButton.classList.add('apply-button');
                    applyCell.appendChild(applyButton);
                });


                // Ajouter des écouteurs d'événements aux boutons "Appliquer"
                document.querySelectorAll('.apply-button').forEach(button => {
                    button.addEventListener('click', async function() {
                        const row = button.closest('tr');
                        const updatedEvent = {};
                        Array.from(row.cells).forEach(cell => {
                            if (cell.dataset.column) {
                                updatedEvent[cell.dataset.column] = cell.textContent.trim();
                            }
                        });

                        const userId = row.dataset.userId;

                        const { error } = await supabase
                            .from('event_quot1')
                            .update(updatedEvent)
                            .eq('user_id', userId);

                            if (error) {
                            console.error('Erreur lors de la mise à jour des données :', error);
                        } else {
                            console.log('Données mises à jour avec succès');
                        }
                    });
                });

                // Mettre en surbrillance la date du jour dans le calendrier
                document.querySelectorAll('.clickable').forEach(cell => {
                    if (parseInt(cell.textContent) === todayDate && todayMonth === currentMonth && todayYear === currentYear) {
                        cell.classList.add('selected');
                    }
                });
            });
        }


        window.onload = function() {
            generateCalendar(currentMonth, currentYear);
            selectToday();
        };

        function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            generateCalendar(currentMonth, currentYear);
        }

        function saveDate() {
            const selectedDateDisplay = document.getElementById('selectedDateDisplay');
            const selectedDate = selectedDateDisplay.textContent.split(' : ')[1];
            const tableBody = document.querySelector('#editable-table tbody');
            const rows = tableBody.querySelectorAll('tr');

            event[selectedDate] = [];
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = {
                    telefono: cells[0].textContent,
                    nombre: cells[1].textContent,
                    fecha: cells[2].textContent,
                    hora: cells[3].textContent,
                    min: cells[4].textContent,
                    lugar: cells[5].textContent,
                    precio: cells[6].textContent,
                    travail: cells[7].textContent
                };
                event[selectedDate].push(rowData);

                // Appel de la fonction addToDataTable2 pour ajouter l'événement à dataTable2
                addToDataTable2(rowData);
            });

            alert('Agenda sauvegardé pour la date : ' + selectedDate);
        }

        // Générer le calendrier pour le mois et l'année actuels
        generateCalendar(currentMonth, currentYear);

        document.addEventListener('DOMContentLoaded', function() {
            loadTableData();
            generateCalendar(currentMonth, currentYear);
            selectToday();

        document.getElementById('addEventButton').addEventListener('click', async function() {
            const newEvent = {
                Telefono: document.getElementById('Telefono').value,
                Nombre: document.getElementById('Nombre').value,
                Fecha: document.getElementById('Fecha').value,
                Hora: document.getElementById('Hora').value,
                Min: document.getElementById('Min').value,
                Lugar: document.getElementById('Lugar').value,
                Precio: document.getElementById('Precio').value,
                Trabajo: document.getElementById('Trabajo').value,
                user_id: uuid.v4() // Générer un UUID valide
            };

            console.log('Nouvel événement à ajouter :', newEvent);

            const { data, error } = await supabase
                .from('event_quot1')
                .insert([newEvent]);

            if (error) {
                console.error('Erreur lors de l\'insertion des données :', error);
            } else {
                console.log('Données insérées avec succès :', data);
                document.getElementById('Telefono').value = '';
                document.getElementById('Nombre').value = '';
                document.getElementById('Fecha').value = '';
                document.getElementById('Hora').value = '';
                document.getElementById('Min').value = '';
                document.getElementById('Lugar').value = '';
                document.getElementById('Precio').value = '';
                document.getElementById('Trabajo').value = '';
                loadTableData(); // Recharger les données pour afficher le nouvel événement
            }
        });

        document.getElementById('Telefono').addEventListener('input', async function() {
            const telefono = this.value;

            if (telefono) {
                const { data, error } = await supabase
                    .from('tableData1')
                    .select('Nombre, Lugar')
                    .eq('Telefono', telefono);

                if (error) {
                    console.error('Erreur lors de la récupération des données :', error);
                } else if (data.length > 0) {
                    const { Nombre, Lugar } = data[0];
                    document.getElementById('Nombre').value = Nombre;
                    document.getElementById('Lugar').value = Lugar;
                } else {
                    // Si aucun résultat n'est trouvé, vider les champs
                    document.getElementById('Nombre').value = '';
                    document.getElementById('Lugar').value = '';
                }
            } else {
                // Si le champ de téléphone est vide, vider les champs
                document.getElementById('Nombre').value = '';
                document.getElementById('Lugar').value = '';
            }
        });
    });

    </script>
</body>
</html>
