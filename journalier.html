<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda total</title>
    <link rel="stylesheet" href="styles1.css">
    <link rel="stylesheet" href="journalier.css">
    <script type="module" src="supabaseClientAgendaJour.js"></script>
</head>
<body>
    <div class="agenda">
        <h1>Agenda Total</h1>
        <table id="journalierTable">
            <thead>
                <tr>
                    <tr>
                    <th>Telefono</th>
                    <th>Nombre</th>
                    <th>Fecha</th>
                    <th>Hora</th>
                    <th>Min</th>
                    <th>Lugar</th>
                    <th>Precio</th>
                    <th>Trabajo</th>
                    <th>user_id</th>
                    <th>Facturación</th> <!-- Colonne combinée -->
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Les lignes seront ajoutées ici par JavaScript -->
            </tbody>
        </table>
        
    </div>
    <script type="module">
        import { supabase } from './supabaseClientAgendaJour.js';

        document.addEventListener('DOMContentLoaded', function() {
            loadTableData();
        });

        // Fonction pour charger les données de la table
        async function loadTableData() {
            const { data, error } = await supabase
                .from('event_quot1')
                .select('*');

            if (error) {
                console.error('Erreur lors de la récupération des données :', error);
                return;
            }

            const tbody = document.querySelector('#journalierTable tbody');
            tbody.innerHTML = ''; // Effacer les anciennes lignes

            data.forEach(event => {
                const row = tbody.insertRow();
                row.dataset.userId = event.user_id; // Ajouter l'attribut data-user-id

                row.innerHTML = `
                    <td contenteditable="true" data-column="Telefono">${event.Telefono}</td>
                    <td contenteditable="true" data-column="Nombre">${event.Nombre}</td>
                    <td contenteditable="true" data-column="Fecha">${event.Fecha}</td>
                    <td contenteditable="true" data-column="Hora">${event.Hora}</td>
                    <td contenteditable="true" data-column="Min">${event.Min !== null ? event.Min : ''}</td>
                    <td contenteditable="true" data-column="Lugar">${event.Lugar !== null ? event.Lugar : ''}</td>
                    <td contenteditable="true" data-column="Precio">${event.Precio !== null ? event.Precio : ''}</td>
                    <td contenteditable="true" data-column="Trabajo">${event.Trabajo !== null ? event.Trabajo : ''}</td>
                    <td>
                        <div class="checkbox-container" style="font-size: smaller;">
                            <label>
                                <input type="checkbox" data-column="Env_datos" ${event.Env_datos ? 'checked' : ''}> - Envié datos
                            </label>
                            <br>
                            <span class="factura-link" style="cursor: pointer; color: blue; text-decoration: underline;" data-factura="${event.Factura}">${event.Factura ? 'Voir la Facture' : 'Adjuntar Factura'}</span>
                            <br>
                            <label>
                                <input type="checkbox" data-column="Pagado" ${event.Pagado ? 'checked' : ''}> - Pagado
                            </label>
                        </div>
                    </td>
                `;

                // Ajouter les écouteurs pour les cases à cocher et les liens de facture
                row.querySelector('[data-column="Env_datos"]').addEventListener('change', updateCheckbox);
                row.querySelector('[data-column="Pagado"]').addEventListener('change', updateCheckbox);
                row.querySelector('.factura-link').addEventListener('click', openFacturaDialog);


                // Ajouter le bouton "Appliquer"
                const applyCell = row.insertCell();
                const applyButton = document.createElement('button');
                applyButton.textContent = 'Aplicar';
                applyButton.classList.add('apply-button');
                applyCell.appendChild(applyButton);
            });


                // Ajouter des écouteurs d'événements aux boutons "Appliquer"
                document.querySelectorAll('.apply-button').forEach(button => {
                    button.addEventListener('click', async function() {
                        const row = button.closest('tr');
                        const updatedEvent = {};
                        Array.from(row.cells).forEach(cell => {
                            if (cell.dataset.column) {
                                updatedEvent[cell.dataset.column] = cell.textContent.trim();
                            }
                        });

                        const userId = row.dataset.userId;

                        const { error } = await supabase
                            .from('event_quot1')
                            .update(updatedEvent)
                            .eq('user_id', userId);

                        if (error) {
                            console.error('Erreur lors de la mise à jour des données :', error);
                        } else {
                            console.log('Données mises à jour avec succès');
                        }
                    });
                });
            } catch (err) {
                console.error('Error loading Supabase client:', err);
            }
        }


    </script>
</body>
</html>
